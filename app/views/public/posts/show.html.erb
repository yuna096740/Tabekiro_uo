<div class="container my-5">
  <div class="row">
    <div class="col-md-7">
      <h4 class="mb-4">お裾分け詳細</h4>
      <div class="text-center">
        <div data-aos="zoom-in" data-aos-duration="2000">
          <%= image_tag @post.get_post_image(600,350), class:"rounded" %>
        </div>
      </div>

      <div class="text-right mt-3 mr-3" id="favorite">
        <%= render 'public/favorites/fav' , post: @post%>
      </div>

      <table class="table table-borderless">
        <tr>
          <th class="col-2">タイトル</th>
          <td><%= @post.title %></td>
        </tr>

        <tr>
          <th>紹介</th>
          <td><%= @post.introduction %></td>
        </tr>

        <tr>
          <th>取引期限</th>
          <td id="timeLimit">
            あと
            <span class="hour"></span>時間
            <span class="min"></span>分
            <span class="sec"></span>秒です。
          </td>
          <td id="hideLimit">
            取引は終了しました。
          </td>
        </tr>

        <tr>
          <th></th>
          <td></td>
        </tr>
      </table>
      <div class="text-center mb-5 mt-3">
        <% if @post.member == current_member %>
          <%= link_to '編集する', edit_post_path(@post), class:"btn btn-success px-5 mr-5 rounded-pill" %>
          <%= link_to '削除する', post_path(@post), method: :delete, data: { confirm: "本当によろしいですか？"}, class:"btn btn-danger px-5 rounded-pill" %>
        <% else %>
          <%= link_to '取引する', root_path, class:"btn btn-success px-5 rounded-pill" %>
        <% end %>
      </div>
    </div>

    <div class="col-md-4 offset-1 mt-5">
      <%= render 'public/post_comments/comment_bar', comment: @comment, post: @post  %>
    </div>
  </div>

  <div class="row mt-3 mb-5">
    <div class="col-md-10 mx-auto mb-5">
      <div class="d-flex my-4">
        <h5>ユーザー登録地名： <%= @post.place_name %></h5>
      </div>
      <div id="map" class="mapShow"></div>
    </div>
  </div>
</div>

<script>
  //カウントダウンタイマー機能
  const elmHour = document.querySelector(".hour");
  const elmMin  = document.querySelector(".min");
  const elmSec  = document.querySelector(".sec");

  const rewriteTime = () => {
    const now = new Date();

    const postCreatedAt = new Date("<%= @post.created_at.iso8601 %>");
    const limit = <%= @post.limit %>
    const limitTime = new Date(postCreatedAt.getTime() + limit * 60 * 60 * 1000);

    const differ = limitTime.getTime() - now.getTime();

    const sec = Math.floor(differ / 1000) % 60;
    const min = Math.floor(differ / 1000 / 60) % 60;
    const hour = Math.floor(differ / 1000 / 60 / 60);

    elmHour.textContent = String(hour).padStart(2, "0");
    elmMin.textContent = String(min).padStart(2, "0");
    elmSec.textContent = String(sec).padStart(2, "0");

    const timeLimit = document.getElementById("timeLimit");
    const hideLimit = document.getElementById("hideLimit");
    if ( differ < 0 ) {
      timeLimit.style.display = "none";
      hideLimit.style.display = "block";
    }
  };
  

  setInterval(rewriteTime, 1000);

  //コメントスクロール位置固定機能
  document.addEventListener("turbolinks:load", () => {
    commentsScrollToEnd();
  });

  //Google Map API
  if (typeof map == "undefined") {
    let map
    let marker
  }
  function initMap(){
    geocoder = new google.maps.Geocoder()

    map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: <%= @post.latitude %>, lng: <%= @post.longitube %> },
      zoom: 15,
    });

    marker = new google.maps.Marker({
      position: { lat: <%= @post.latitude %>, lng: <%= @post.longitube %> },
      map: map
    });
  }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['API_KEY'] %>&libraries=places&callback=initMap" async defer></script>